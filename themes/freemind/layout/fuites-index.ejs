<style>
  #fuites-container {
    padding: 2em;
    font-family: sans-serif;
  }
  .fuite-list-item {
    border-bottom: 1px solid #eee;
    padding: 1em 0;
  }
  .fuite-list-item a {
    font-size: 1.2em;
    text-decoration: none;
    color: #fa0505;
  }
  .fuite-list-item p {
    color: #e00a0a;
    margin: 0.5em 0 0 0;
  }
  .breach-details {
    padding: 0;
  }
  .breach-header {
    border-bottom: 2px solid #eee;
    padding-bottom: 1em;
    margin-bottom: 1em;
  }
  .breach-header h1 {
    font-size: 2.5em;
    margin: 0;
  }
  .breach-meta {
    display: flex;
    gap: 2em;
    margin-top: 1em;
    color: #555;
  }
  .meta-item {
    display: flex;
    flex-direction: column;
  }
  .meta-label {
    font-weight: bold;
    font-size: 0.9em;
    color: #f8f5f5;
  }
  .meta-value {
    font-size: 1.1em;
  }
  .breach-content {
    margin-top: 2em;
  }
  .breach-content h2 {
    font-size: 1.5em;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5em;
    margin-top: 1.5em;
  }
  .breach-content .description {
    line-height: 1.6;
  }
  .data-classes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
    margin-top: 1em;
  }
  .data-class {
    background-color: #eef;
    padding: 0.3em 0.8em;
    border-radius: 15px;
    font-size: 0.9em;
  }
  .nsfw-warning {
    background-color: #fff3e0;
    border: 1px solid #ff9800;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
  }
  .nsfw-warning h2 {
    margin: 0;
    color: #ff5722;
  }
  .nsfw-link.hidden {
    display: none;
  }
  .show-nsfw-link {
    background-color: #ff9800;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.9em;
  }
</style>

<div id="fuites-container">
  <h1>Chargement des données...</h1>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('fuites-container');
    const params = new URLSearchParams(window.location.search);
    const breachId = params.get('id');

    // Le chemin vers le fichier JSON
    const dataUrl = '/data/breaches.json';

    fetch(dataUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        const breaches = data.breaches.filter((item) => !item.IsRetired);
        if (breachId !== null && breaches[breachId]) {
          renderDetails(breaches[breachId], breachId);
        } else {
          renderList(breaches);
        }
      })
      .catch(error => {
        container.innerHTML = '<h1>Erreur</h1><p>Impossible de charger le fichier de données des fuites. Veuillez vérifier que le fichier <code>source/_data/breaches.json</code> existe et est accessible.</p><p>Détail de l\'erreur: ' + error + '</p>';
      });

    function renderList(breaches) {
      let html = '<h1>Liste des Fuites de Données</h1>';
      if (!breaches || breaches.length === 0) {
        html += '<p>Aucune fuite de données trouvée.</p>';
        container.innerHTML = html;
        return;
      }
      html += '<h1>Total : ' + breaches.length + '</h1>';
      html += breaches.filter((item) => !item.Name.includes('cve'))
        .map((breach, index) => `
          <div class="fuite-list-item">
            ${breach.isNSFW ?
              `
              <div class="nsfw-warning">
                <h2>⚠️ Attention : Lien potentiellement inadapté (NSFW)</h2>
                <p>Ce lien peut contenir du contenu sensible.</p>
                <button onclick="confirmShowLink(event, '${breach.index}')" class="show-nsfw-link">Afficher le lien</button>
                <a href="https://feed-blush.vercel.app/fuites?id=${breach.index}" class="nsfw-link hidden">${breach.Title || breach.Name}</a>
              </div>
              ` :
              `<a href="https://feed-blush.vercel.app/fuites?id=${breach.index}">${breach.Title || breach.Name}</a>`
            }
            <p>Date: ${new Date(breach.BreachDate).toLocaleDateString('fr-FR')}</p>
            ${breach.DataClasses && breach.DataClasses.length > 0 ?
              `
              <h2>Données compromises</h2>
              <div class="data-classes">
                ${breach.DataClasses.map(item => `<span class="data-class">${item}</span>`).join('')}
              </div>
              ` : ''
            }
          </div>
        `).join('');
      container.innerHTML = html;
    }

    function renderDetails(breach, index) {
      let html = `
        <div class="breach-details">
          <div class="breach-header">
            <h1>${breach.Title}</h1>
            ${breach.isNSFW ?
              `
              <div class="nsfw-warning">
                <h2>⚠️ Attention : Contenu potentiellement inadapté (NSFW)</h2>
              </div>
              ` : ''
            }
            <div class="breach-meta">
              <div class="meta-item">
                <span class="meta-label">Date de la fuite</span>
                <span class="meta-value">${new Date(breach.BreachDate).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
             
                </div>
              ${breach.PwnCount > 0 ?
                `
                <div class="meta-item">
                  <span class="meta-label">Comptes affectés</span>
                  <span class="meta-value">${breach.PwnCount.toLocaleString('fr-FR')}</span>
                </div>
                ` : ''
              }
                    ${breach.Domain?
                `
                <div class="meta-item">
                  <span class="meta-label">domaine</span>
                  <span class="meta-value">${breach.Domain}</span>
                </div>
                ` : ` <div class="meta-item">
                  <span class="meta-label">domaine</span>
                  <span class="meta-value">${breach.Domain}</span>
                </div>`
              }

            </div>
          </div>
          <div class="breach-content">
            <h2>Description</h2>
            <div class="description">${breach.Description}</div>
            ${breach.DataClasses && breach.DataClasses.length > 0 ?
              `
              <h2>Données compromises</h2>
              <div class="data-classes">
                ${breach.DataClasses.map(item => `<span class="data-class">${item}</span>`).join('')}
              </div>
              ` : ''
            }
            ${breach.lien ?
              `
              <h2>Plus d'informations</h2>
              <p>
                ${breach.isNSFW ?
                  `
                  <button onclick="confirmShowExternalLink(event)" class="show-nsfw-link">Afficher le lien externe</button>
                  <a href="${breach.lien}" target="_blank" rel="noopener noreferrer" class="hidden">Annonce officielle de la fuite</a>
                  ` :
                  `<a href="${breach.lien}" target="_blank" rel="noopener noreferrer">Annonce officielle de la fuite</a>`
                }
              </p>
              ` : ''
            }
          </div>
        </div>
        <hr>
        <a href="/fuites?id=${parseInt(breach.index)-1}">Précédent</a>
        <a href="/fuites/">Retour à la liste</a>
        <a href="/fuites?id=${parseInt(breach.index)+1}">Suivant</a>
      `;
      container.innerHTML = html;
    }

    // Fonction pour afficher un lien NSFW dans la liste
    function confirmShowLink(event, index) {
      event.preventDefault();
      const userConfirmed = confirm("Ce lien mène vers un contenu NSFW. Êtes-vous sûr de vouloir l'afficher ?");
      if (userConfirmed) {
        const link = document.querySelector(`a[href="https://feed-blush.vercel.app/fuites?id=${index}"]`);
        link.classList.remove('hidden');
        event.target.style.display = 'none';
      }
    }

    // Fonction pour afficher un lien externe NSFW dans les détails
    function confirmShowExternalLink(event) {
      event.preventDefault();
      const userConfirmed = confirm("Ce lien mène vers un contenu NSFW. Êtes-vous sûr de vouloir l'ouvrir ?");
      if (userConfirmed) {
        const link = event.target.nextElementSibling;
        link.classList.remove('hidden');
        event.target.style.display = 'none';
      }
    }
  });
</script>
