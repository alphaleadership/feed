<div class="row page">
<script src="<%- config.url %>/js/index.js"></script>

	<% if (theme.widgets.length) { %>
	<div class="col-md-9">
	<% } else { %>
	<div class="col-md-12">
	<% } %>

	<!-- Donn√©es les plus fuit√©es -->
	<div class="dataclass-stats card shadow-sm mb-4" style="background: linear-gradient(135deg, #2e1a1a 0%, #3e1616 100%); border: none;">
		<div class="card-header bg-dark text-white" style="background: rgba(0,0,0,0.5) !important; border-bottom: 2px solid rgba(255,255,255,0.1);">
			<h3 class="mb-0">üîê Types de donn√©es les plus fuit√©s </h3>
		</div>
		<div class="card-body" style="background: #2e1e1e; padding: 1.5rem;">
			<div class="row" id="dataclass-container">
				<div class="col-12 text-center py-5">
					<div class="spinner-border text-danger" role="status">
						<span class="visually-hidden">Chargement...</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Entreprises les plus touch√©es -->
	<div class="company-stats card shadow-sm mb-4" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border: none;">
		<div class="card-header bg-dark text-white" style="background: rgba(0,0,0,0.5) !important; border-bottom: 2px solid rgba(255,255,255,0.1);">
			<h3 class="mb-0">üè¢ Entreprises / Sites les plus touch√©s </h3>
		</div>
		<div class="card-body" style="background: #1f2937; padding: 1.5rem;">
			<div class="row" id="company-container">
				<div class="col-12 text-center py-5">
					<div class="spinner-border text-success" role="status">
						<span class="visually-hidden">Chargement...</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Syst√®me de notes - Cat√©gories les plus fr√©quentes -->
	<div class="category-stats card shadow-sm mb-4">
		<div class="card-header bg-dark text-white">
			<h3 class="mb-0">üìä entreprise ayant eu le plus de fuite </h3>
			<small class="text-muted" id="breach-count">Chargement...</small>
		</div>
		<div class="card-body">
			<div class="row" id="category-container">
				<div class="col-12 text-center py-5">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Chargement...</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		const invalidcategory=["hygi√®ne num√©rique","s√©curit√©","cybers√©curit√©","cybercriminalit√©","cyberguerre"]
		// Charger et analyser les donn√©es avec fetch
		fetch('<%- config.url %>/data/breaches.json')
			.then(response => response.json())
			.then(data => {
				const categoryBreaches = {};
				const dataClassStats = {};
				const companyStats = {};
				
				// Associer chaque cat√©gorie avec ses fuites
				data.breaches.filter((item)=>{return ! item.isRetired}).forEach(breach => {
					if (breach.DataClasses && Array.isArray(breach.DataClasses)) {
						breach.DataClasses.forEach(dc => {
							if (!dataClassStats[dc]) {
								dataClassStats[dc] = { count: 0, pwnCount: 0 };
							}
							dataClassStats[dc].count++;
							dataClassStats[dc].pwnCount += (breach.PwnCount || 0);
						});
					}

					// Stats pour les entreprises / sites
					let compName = breach.Domain || breach.Title || breach.Name;
					if (compName) {
						let normName = compName.toLowerCase();
						if (normName.includes('france travail') || normName.includes('pole emploi') || normName.includes('p√¥le emploi')) {
							compName = 'France Travail';
							breach.Domain = breach.Domain || 'francetravail.fr';
						} else if (compName.toLowerCase().includes(' fuite du ')) {
							compName = compName.replace(/ fuite du .*/i, '').trim();
							// Capitaliser la premi√®re lettre si tout est en minuscules
							if (compName === compName.toLowerCase()) {
								compName = compName.charAt(0).toUpperCase() + compName.slice(1);
							}
						}

						// Uniformiser la casse
						const keyName = compName.toLowerCase();

						if (!companyStats[keyName]) {
							companyStats[keyName] = { 
								name: compName, 
								count: 0, 
								pwnCount: 0,
								domain: breach.Domain
							};
						}
						companyStats[keyName].count++;
						companyStats[keyName].pwnCount += (breach.PwnCount || 0);
						if (breach.Domain && !companyStats[keyName].domain) {
							companyStats[keyName].domain = breach.Domain;
						}
					}

					if (breach.categories && Array.isArray(breach.categories)) {
						breach.categories.map(item=>{
							return item.split("fuite")[0]
						}).forEach(category => {
							if(category==""){
								return
							}
								if(!isNaN(parseInt(category))){
								invalidcategory.push(category)
							}
							if(invalidcategory.includes(category.toLowerCase())){
								return
							}
						
							if (!categoryBreaches[category.toLowerCase()]) {
								categoryBreaches[category.toLowerCase()] = [];
							}
							categoryBreaches[category.toLowerCase()].push({
								name: breach.Name,
								title: breach.Title,
								slug: breach.slug,
								path: breach.index,
								pwnCount: breach.PwnCount,
								date: breach.BreachDate,
								nsfw:breach.isNSFW
							});
						});
					}
				});
				console.log(categoryBreaches)
				// Trier et prendre les 15 premiers
				const sortedCategories = Object.entries(categoryBreaches)
					.sort((a, b) => b[1].length - a[1].length)
					.slice(0, 15)
					.map(([name, breaches]) => ({ 
						name:name||"inconnu", 
						count: breaches.length,
						breaches: breaches.sort((a, b) => b.pwnCount - a.pwnCount).slice(0, 50),
						percentage: ((breaches.length / data.totalBreaches) * 100).toFixed(1) 
					}));
				
				// Trier et pr√©parer les stats DataClasses
				const sortedDataClasses = Object.entries(dataClassStats)
					.sort((a, b) => b[1].count - a[1].count)
					.slice(0, 8)
					.map(([name, stats]) => ({
						name,
						count: stats.count,
						pwnCount: stats.pwnCount
					}));

				const dcContainer = document.getElementById('dataclass-container');
				if (dcContainer) {
					dcContainer.innerHTML = sortedDataClasses.map((dc, idx) => {
						const borderClass = idx < 3 ? 'border-danger' : idx < 7 ? 'border-warning' : 'border-info';
						const badgeClass = idx < 3 ? 'bg-danger' : idx < 7 ? 'bg-warning text-dark' : 'bg-info';
						return `
							<div class="col-md-3 col-sm-6 mb-3">
								<div class="note-card p-3 border rounded ${borderClass} h-100" style="background: linear-gradient(145deg, #382525 0%, #3e2a2a 100%);">
									<div class="d-flex justify-content-between align-items-center mb-2">
										<span class="badge ${badgeClass} fs-6">#${idx + 1}</span>
									</div>
									<h5 class="mb-2" style="color:#e0e0e0; font-size: 1.1rem; word-break: break-word;">${dc.name}</h5>
									<p class="mb-1 text-muted" style="font-size:0.9em;"><strong>${dc.count.toLocaleString()}</strong> fuites</p>
									<p class="mb-0 text-muted" style="font-size:0.8em; opacity: 0.8;">Touches ~<strong>${(dc.pwnCount / 1000000).toFixed(1)}M</strong> de comptes</p>
								</div>
							</div>
						`;
					}).join('');
				}

				// Trier et pr√©parer les stats Entreprises
				const sortedCompanies = Object.values(companyStats)
					.sort((a, b) => b.pwnCount - a.pwnCount)
					.slice(0, 12);

				const compContainer = document.getElementById('company-container');
				if (compContainer) {
					compContainer.innerHTML = sortedCompanies.map((comp, idx) => {
						const borderClass = idx < 3 ? 'border-danger' : idx < 7 ? 'border-warning' : 'border-success';
						const badgeClass = idx < 3 ? 'bg-danger' : idx < 7 ? 'bg-warning text-dark' : 'bg-success';
						const domainLink = comp.domain && comp.domain !== comp.name ? `<br><a href="http://${comp.domain}" target="_blank" rel="noopener noreferrer" style="color:#a7f3d0; font-size: 0.8em; text-decoration: none;">${comp.domain}</a>` : '';
						return `
							<div class="col-md-3 col-sm-6 mb-3">
								<div class="note-card p-3 border rounded ${borderClass} h-100" style="background: linear-gradient(145deg, #374151 0%, #1f2937 100%);">
									<div class="d-flex justify-content-between align-items-center mb-2">
										<span class="badge ${badgeClass} fs-6">#${idx + 1}</span>
									</div>
									<h5 class="mb-1" style="color:#f3f4f6; font-size: 1.1rem; word-break: break-word;">${comp.name}${domainLink}</h5>
									<p class="mt-2 mb-0 text-muted" style="font-size:0.9em; color: #9ca3af !important;">
										<strong>${(comp.pwnCount >= 1000000 ? (comp.pwnCount / 1000000).toFixed(1) + 'M' : comp.pwnCount.toLocaleString())}</strong> de comptes<br>
										<span style="font-size:0.8em; opacity: 0.8;">via ${comp.count} fuite${comp.count > 1 ? 's' : ''}</span>
									</p>
								</div>
							</div>
						`;
					}).join('');
				}

				// Mettre √† jour le compteur
				document.getElementById('breach-count').textContent = 
					`Bas√© sur ${data.totalBreaches.toLocaleString()} fuites analys√©es`;
				
				// G√©n√©rer le HTML des cat√©gories
				const container = document.getElementById('category-container');
				container.innerHTML = sortedCategories.map((cat, idx) => {
					const borderClass = idx < 3 ? 'border-danger' : idx < 8 ? 'border-warning' : 'border-info';
					const badgeClass = idx < 3 ? 'bg-danger' : idx < 8 ? 'bg-warning text-dark' : 'bg-info';
					
					const breachLinks = cat.breaches.map(breach => 
						`<li class="breach-link-item ${breach.nsfw ? 'border-warning' : 'border-info'}">

							<a href="<%- config.url %>/fuites?id=${breach.path}" class="text-decoration-none">
								${breach.title} <span class="text-muted small">(${(breach.pwnCount / 1000000).toFixed(1)}M)</span>
							</a>
						</li>`
					).join('');
					
					return `
						<div class="col-md-4 col-sm-6 mb-3">
							<div class="note-card p-3 border rounded ${borderClass} h-100">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="badge ${badgeClass} fs-6">#${idx + 1}</span>
									<span class="text-muted small">${cat.percentage}%</span>
								</div>
								<h5 class="mb-2">${cat.name}</h5>
								<p class="mb-2 text-muted"><strong>${cat.count.toLocaleString()}</strong> fuites</p>
								<details class="breach-details">
									<summary class="text-primary" style="cursor: pointer;">Top 5 fuites</summary>
									<ul class="breach-list mt-2 ps-3">
										${breachLinks}
									</ul>
								</details>
							</div>
						</div>
					`;
				}).join('');
			})
			.catch(error => {
				console.error('Erreur chargement des donn√©es:', error);
				document.getElementById('category-container').innerHTML = 
					'<div class="col-12 text-center text-danger">Erreur de chargement des donn√©es</div>';
			});
	</script>

	<style>
		.category-stats {
			background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
			border: none;
		}
		.category-stats .card-header {
			background: rgba(0,0,0,0.5) !important;
			border-bottom: 2px solid rgba(255,255,255,0.1);
		}
		.category-stats .card-header h3 {
			color: #fff;
		}
		.category-stats .card-header small {
			color: #aaa !important;
		}
		.category-stats .card-body {
			background: #1e1e2e;
			padding: 1.5rem;
		}
		.note-card {
			transition: transform 0.2s, box-shadow 0.2s;
			background: linear-gradient(145deg, #252538 0%, #2a2a3e 100%);
			border-color: rgba(255,255,255,0.1) !important;
		}
		.note-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 8px 24px rgba(0,0,0,0.4);
			background: linear-gradient(145deg, #2a2a3e 0%, #2f2f48 100%);
		}
		.note-card h5 {
			color: #e0e0e0;
		}
		.note-card .text-muted {
			color: #999 !important;
		}
		.breach-details summary {
			font-size: 0.9rem;
			font-weight: 500;
			margin-top: 0.5rem;
			color: #6c9fff;
		}
		.breach-details[open] summary {
			margin-bottom: 0.5rem;
		}
		.breach-list {
			list-style: none;
			padding-left: 0;
			font-size: 0.85rem;
		}
		.breach-link-item {
			padding: 0.25rem 0;
			border-bottom: 1px solid rgba(255,255,255,0.05);
		}
		.breach-link-item:last-child {
			border-bottom: none;
		}
		.breach-link-item a {
			color: #b8b8d1;
			transition: color 0.2s;
		}
		.breach-link-item a:hover {
			color: #8ab4ff;
		}
		.breach-link-item .text-muted {
			color: #666 !important;
		}
		.spinner-border {
			color: #6c9fff !important;
		}
	</style>

		<%- partial('post/slogan') %>
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
     
		</div>

		<!-- pagination -->
		<div>
  		<center>
		<%- partial('index_pagination') %>
  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	<% if (theme.widgets.length) { %>
		<%- partial('sidebar') %>
	<% } %>

</div> <!-- row-fluid -->
